<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Panel - Payment Gateway</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;700;900&family=Rajdhani:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getDatabase, ref, set, get, onValue, update, remove, query, orderByChild } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyA8C1-TpsRo0UsATshlI8Dy0v40PnLRlc4",
    authDomain: "mines-67d8c.firebaseapp.com",
    databaseURL: "https://mines-67d8c-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "mines-67d8c",
    storageBucket: "mines-67d8c.firebasestorage.app",
    messagingSenderId: "918317634273",
    appId: "1:918317634273:web:8527c0d58a1f3de0371da0",
    measurementId: "G-NHC6K1X3KZ"
  };

  const app = initializeApp(firebaseConfig);
  window.db = getDatabase(app);
  window.dbRef = ref;
  window.dbSet = set;
  window.dbGet = get;
  window.dbOnValue = onValue;
  window.dbUpdate = update;
  window.dbRemove = remove;
  window.dbQuery = query;
  window.dbOrderByChild = orderByChild;
</script>

<style>
:root {
  --gold: #f0c040;
  --neon-cyan: #22d3ee;
  --neon-emerald: #34d399;
  --neon-amber: #fbbf24;
  --neon-rose: #fb7185;
  --bg-deep: #0a0c14;
  --glass-bg: rgba(18, 22, 40, 0.85);
  --glass-border: rgba(255,255,255,0.15);
  --text-primary: #f0f0f5;
  --text-muted: #9aa0b8;
  --radius: 12px;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Rajdhani', sans-serif;
  background: var(--bg-deep);
  color: var(--text-primary);
  min-height: 100vh;
  padding: 20px;
}

.container {
  max-width: 1400px;
  margin: 0 auto;
}

.header {
  background: var(--glass-bg);
  backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: var(--radius);
  padding: 24px;
  margin-bottom: 24px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.title {
  font-family: 'Orbitron', sans-serif;
  font-size: 28px;
  font-weight: 700;
  background: linear-gradient(135deg, var(--gold), var(--neon-amber));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
  gap: 16px;
  margin-bottom: 24px;
}

.stat-card {
  background: var(--glass-bg);
  backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: var(--radius);
  padding: 20px;
  text-align: center;
}

.stat-label {
  font-size: 12px;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 1px;
  margin-bottom: 8px;
}

.stat-value {
  font-size: 32px;
  font-weight: 700;
  font-family: 'Orbitron', sans-serif;
}

.stat-value.green { color: var(--neon-emerald); }
.stat-value.amber { color: var(--neon-amber); }
.stat-value.cyan { color: var(--neon-cyan); }
.stat-value.rose { color: var(--neon-rose); }

.tabs {
  display: flex;
  gap: 12px;
  margin-bottom: 24px;
}

.tab {
  background: rgba(255,255,255,0.05);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: var(--radius);
  padding: 12px 24px;
  cursor: pointer;
  transition: all 0.3s;
  font-weight: 600;
}

.tab:hover {
  background: rgba(255,255,255,0.08);
}

.tab.active {
  background: linear-gradient(135deg, rgba(34,211,238,0.2), rgba(52,211,153,0.2));
  border-color: var(--neon-cyan);
}

.table-container {
  background: var(--glass-bg);
  backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: var(--radius);
  overflow: hidden;
}

table {
  width: 100%;
  border-collapse: collapse;
}

thead {
  background: rgba(255,255,255,0.05);
}

th {
  padding: 16px;
  text-align: left;
  font-weight: 600;
  color: var(--neon-cyan);
  text-transform: uppercase;
  font-size: 12px;
  letter-spacing: 1px;
}

td {
  padding: 16px;
  border-top: 1px solid rgba(255,255,255,0.05);
}

tr:hover {
  background: rgba(255,255,255,0.03);
}

.badge {
  display: inline-block;
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
}

.badge.pending {
  background: rgba(251,191,36,0.2);
  color: var(--neon-amber);
  border: 1px solid var(--neon-amber);
}

.badge.success {
  background: rgba(52,211,153,0.2);
  color: var(--neon-emerald);
  border: 1px solid var(--neon-emerald);
}

.badge.failed {
  background: rgba(251,113,133,0.2);
  color: var(--neon-rose);
  border: 1px solid var(--neon-rose);
}

.btn {
  background: linear-gradient(135deg, var(--neon-emerald), #10b981);
  color: white;
  border: none;
  border-radius: 6px;
  padding: 8px 16px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
  font-size: 12px;
  text-transform: uppercase;
}

.btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(52,211,153,0.4);
}

.btn-danger {
  background: linear-gradient(135deg, var(--neon-rose), #f43f5e);
}

.btn-danger:hover {
  box-shadow: 0 4px 12px rgba(251,113,133,0.4);
}

.btn-group {
  display: flex;
  gap: 8px;
}

.empty-state {
  text-align: center;
  padding: 60px 20px;
  color: var(--text-muted);
}

.empty-state-icon {
  font-size: 48px;
  margin-bottom: 16px;
  opacity: 0.3;
}

.hidden {
  display: none !important;
}

.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.85);
  backdrop-filter: blur(8px);
  z-index: 9999;
  align-items: center;
  justify-content: center;
}

.modal.active {
  display: flex;
}

.modal-content {
  background: var(--glass-bg);
  backdrop-filter: blur(30px);
  border: 1px solid var(--glass-border);
  border-radius: var(--radius);
  padding: 32px;
  max-width: 500px;
  width: 90%;
  max-height: 80vh;
  overflow-y: auto;
}

.modal-title {
  font-size: 24px;
  font-weight: 700;
  margin-bottom: 20px;
  color: var(--gold);
}

.detail-row {
  display: flex;
  justify-content: space-between;
  padding: 12px 0;
  border-bottom: 1px solid rgba(255,255,255,0.05);
}

.detail-label {
  color: var(--text-muted);
  font-size: 13px;
}

.detail-value {
  font-weight: 600;
  font-family: 'Orbitron', sans-serif;
}

.close-modal {
  position: absolute;
  top: 16px;
  right: 20px;
  font-size: 28px;
  cursor: pointer;
  color: var(--text-muted);
}

.close-modal:hover {
  color: var(--neon-rose);
}

.search-box {
  background: rgba(255,255,255,0.05);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: var(--radius);
  padding: 12px 16px;
  width: 300px;
  color: var(--text-primary);
  font-family: 'Rajdhani', sans-serif;
  font-size: 14px;
}

.search-box:focus {
  outline: none;
  border-color: var(--neon-cyan);
}

.logout-btn {
  background: linear-gradient(135deg, var(--neon-rose), #f43f5e);
  color: white;
  border: none;
  border-radius: 6px;
  padding: 10px 20px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
}

.logout-btn:hover {
  transform: translateY(-2px);
}
</style>
</head>
<body>

<div class="container">
  <!-- Login Screen -->
  <div id="loginScreen">
    <div class="header" style="max-width: 400px; margin: 100px auto; display: block;">
      <div class="title" style="text-align: center; margin-bottom: 24px;">Admin Login</div>
      <input type="password" id="adminPassword" class="search-box" placeholder="Enter Admin Password" style="width: 100%; margin-bottom: 16px;">
      <button class="btn" style="width: 100%;" onclick="adminLogin()">Login</button>
    </div>
  </div>

  <!-- Admin Dashboard -->
  <div id="adminDashboard" class="hidden">
    <!-- Header -->
    <div class="header">
      <h1 class="title">üîê Admin Panel - Payment Gateway</h1>
      <div style="display: flex; gap: 12px; align-items: center;">
        <input type="text" id="searchBox" class="search-box" placeholder="Search transaction ID..." onkeyup="searchTransactions()">
        <button class="logout-btn" onclick="adminLogout()">Logout</button>
      </div>
    </div>

    <!-- Stats -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">Total Transactions</div>
        <div class="stat-value cyan" id="statTotal">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Pending</div>
        <div class="stat-value amber" id="statPending">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Successful</div>
        <div class="stat-value green" id="statSuccess">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Failed</div>
        <div class="stat-value rose" id="statFailed">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Total Volume</div>
        <div class="stat-value green" id="statVolume">Rs 0</div>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <div class="tab active" onclick="switchTab('all')">All Transactions</div>
      <div class="tab" onclick="switchTab('pending')">Pending</div>
      <div class="tab" onclick="switchTab('success')">Successful</div>
      <div class="tab" onclick="switchTab('failed')">Failed</div>
    </div>

    <!-- Transactions Table -->
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Transaction ID</th>
            <th>User</th>
            <th>Amount</th>
            <th>Method</th>
            <th>Status</th>
            <th>Date/Time</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="transactionsTableBody">
          <tr>
            <td colspan="7">
              <div class="empty-state">
                <div class="empty-state-icon">üìä</div>
                <div>Loading transactions...</div>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Transaction Details Modal -->
<div id="detailsModal" class="modal">
  <div class="modal-content" style="position: relative;">
    <span class="close-modal" onclick="closeDetailsModal()">&times;</span>
    <div class="modal-title">Transaction Details</div>
    <div id="transactionDetails"></div>
    <div class="btn-group" style="margin-top: 24px;" id="modalActions"></div>
  </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ADMIN AUTHENTICATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const ADMIN_PASSWORD = 'admin123'; // Change this to secure password
let isAdminLoggedIn = false;
let allTransactions = [];
let currentFilter = 'all';

function adminLogin() {
  const password = document.getElementById('adminPassword').value;
  
  if (password === ADMIN_PASSWORD) {
    isAdminLoggedIn = true;
    localStorage.setItem('adminAuth', 'true');
    document.getElementById('loginScreen').classList.add('hidden');
    document.getElementById('adminDashboard').classList.remove('hidden');
    loadAllTransactions();
  } else {
    alert('Invalid password!');
  }
}

function adminLogout() {
  isAdminLoggedIn = false;
  localStorage.removeItem('adminAuth');
  document.getElementById('adminDashboard').classList.add('hidden');
  document.getElementById('loginScreen').classList.remove('hidden');
}

// Check existing session
window.addEventListener('load', () => {
  const isAuth = localStorage.getItem('adminAuth');
  if (isAuth === 'true') {
    isAdminLoggedIn = true;
    document.getElementById('loginScreen').classList.add('hidden');
    document.getElementById('adminDashboard').classList.remove('hidden');
    loadAllTransactions();
  }
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LOAD TRANSACTIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadAllTransactions() {
  const transactionsRef = dbRef(db, 'transactions');
  
  dbOnValue(transactionsRef, (snapshot) => {
    allTransactions = [];
    
    if (snapshot.exists()) {
      const data = snapshot.val();
      for (let txnId in data) {
        allTransactions.push(data[txnId]);
      }
    }
    
    // Sort by date (newest first)
    allTransactions.sort((a, b) => b.createdAt - a.createdAt);
    
    updateStats();
    renderTransactions();
  });
}

function updateStats() {
  const total = allTransactions.length;
  const pending = allTransactions.filter(t => t.status === 'PENDING').length;
  const success = allTransactions.filter(t => t.status === 'SUCCESS').length;
  const failed = allTransactions.filter(t => t.status === 'FAILED' || t.status === 'EXPIRED').length;
  
  const totalVolume = allTransactions
    .filter(t => t.status === 'SUCCESS')
    .reduce((sum, t) => sum + t.amount, 0);
  
  document.getElementById('statTotal').textContent = total;
  document.getElementById('statPending').textContent = pending;
  document.getElementById('statSuccess').textContent = success;
  document.getElementById('statFailed').textContent = failed;
  document.getElementById('statVolume').textContent = `Rs ${totalVolume.toLocaleString()}`;
}

function renderTransactions() {
  const tbody = document.getElementById('transactionsTableBody');
  
  let filteredTransactions = allTransactions;
  
  // Apply filter
  if (currentFilter !== 'all') {
    if (currentFilter === 'failed') {
      filteredTransactions = allTransactions.filter(t => 
        t.status === 'FAILED' || t.status === 'EXPIRED'
      );
    } else {
      filteredTransactions = allTransactions.filter(t => 
        t.status.toLowerCase() === currentFilter
      );
    }
  }
  
  // Apply search
  const searchTerm = document.getElementById('searchBox')?.value.toLowerCase();
  if (searchTerm) {
    filteredTransactions = filteredTransactions.filter(t => 
      t.transactionId.toLowerCase().includes(searchTerm) ||
      t.userId.toLowerCase().includes(searchTerm)
    );
  }
  
  if (filteredTransactions.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="7">
          <div class="empty-state">
            <div class="empty-state-icon">üì≠</div>
            <div>No transactions found</div>
          </div>
        </td>
      </tr>
    `;
    return;
  }
  
  tbody.innerHTML = filteredTransactions.map(txn => `
    <tr>
      <td><code style="color: var(--neon-cyan);">${txn.transactionId}</code></td>
      <td>${txn.userId}</td>
      <td><strong>Rs ${txn.amount}</strong></td>
      <td>${txn.paymentMethod === 'jazzcash' ? 'üì± JazzCash' : 'üí≥ EasyPaisa'}</td>
      <td><span class="badge ${txn.status.toLowerCase()}">${txn.status}</span></td>
      <td>${formatDate(txn.createdAt)}</td>
      <td>
        <div class="btn-group">
          <button class="btn" onclick='viewDetails(${JSON.stringify(txn)})'>View</button>
          ${txn.status === 'PENDING' ? `
            <button class="btn" onclick="approveTransaction('${txn.transactionId}')">Approve</button>
            <button class="btn btn-danger" onclick="rejectTransaction('${txn.transactionId}')">Reject</button>
          ` : ''}
        </div>
      </td>
    </tr>
  `).join('');
}

function formatDate(timestamp) {
  const date = new Date(timestamp);
  return date.toLocaleString('en-US', {
    month: 'short',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  });
}

function switchTab(filter) {
  currentFilter = filter;
  
  // Update tab styles
  document.querySelectorAll('.tab').forEach(tab => {
    tab.classList.remove('active');
  });
  event.target.classList.add('active');
  
  renderTransactions();
}

function searchTransactions() {
  renderTransactions();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TRANSACTION ACTIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function approveTransaction(transactionId) {
  if (!confirm('Approve this transaction? This will credit the user\'s balance.')) {
    return;
  }
  
  try {
    const transactionRef = dbRef(db, `transactions/${transactionId}`);
    const snapshot = await dbGet(transactionRef);
    
    if (snapshot.exists()) {
      const txnData = snapshot.val();
      
      // Update transaction status
      await dbUpdate(transactionRef, {
        status: 'SUCCESS',
        approvedAt: Date.now(),
        approvedBy: 'admin'
      });
      
      // The client-side listener will automatically credit the balance
      alert('Transaction approved successfully!');
    }
  } catch (error) {
    console.error('Error approving transaction:', error);
    alert('Failed to approve transaction');
  }
}

async function rejectTransaction(transactionId) {
  if (!confirm('Reject this transaction? This action cannot be undone.')) {
    return;
  }
  
  try {
    const transactionRef = dbRef(db, `transactions/${transactionId}`);
    await dbUpdate(transactionRef, {
      status: 'FAILED',
      rejectedAt: Date.now(),
      rejectedBy: 'admin'
    });
    
    alert('Transaction rejected');
  } catch (error) {
    console.error('Error rejecting transaction:', error);
    alert('Failed to reject transaction');
  }
}

function viewDetails(txn) {
  const modal = document.getElementById('detailsModal');
  const detailsDiv = document.getElementById('transactionDetails');
  const actionsDiv = document.getElementById('modalActions');
  
  detailsDiv.innerHTML = `
    <div class="detail-row">
      <span class="detail-label">Transaction ID:</span>
      <span class="detail-value">${txn.transactionId}</span>
    </div>
    <div class="detail-row">
      <span class="detail-label">User Phone:</span>
      <span class="detail-value">${txn.userId}</span>
    </div>
    <div class="detail-row">
      <span class="detail-label">Amount:</span>
      <span class="detail-value" style="color: var(--neon-emerald);">Rs ${txn.amount}</span>
    </div>
    <div class="detail-row">
      <span class="detail-label">Payment Method:</span>
      <span class="detail-value">${txn.paymentMethod === 'jazzcash' ? 'JazzCash' : 'EasyPaisa'}</span>
    </div>
    <div class="detail-row">
      <span class="detail-label">Status:</span>
      <span class="badge ${txn.status.toLowerCase()}">${txn.status}</span>
    </div>
    <div class="detail-row">
      <span class="detail-label">Created At:</span>
      <span class="detail-value">${new Date(txn.createdAt).toLocaleString()}</span>
    </div>
    <div class="detail-row">
      <span class="detail-label">Expires At:</span>
      <span class="detail-value">${new Date(txn.expiresAt).toLocaleString()}</span>
    </div>
    ${txn.approvedAt ? `
      <div class="detail-row">
        <span class="detail-label">Approved At:</span>
        <span class="detail-value">${new Date(txn.approvedAt).toLocaleString()}</span>
      </div>
    ` : ''}
  `;
  
  if (txn.status === 'PENDING') {
    actionsDiv.innerHTML = `
      <button class="btn" onclick="approveTransaction('${txn.transactionId}'); closeDetailsModal();">Approve</button>
      <button class="btn btn-danger" onclick="rejectTransaction('${txn.transactionId}'); closeDetailsModal();">Reject</button>
    `;
  } else {
    actionsDiv.innerHTML = '';
  }
  
  modal.classList.add('active');
}

function closeDetailsModal() {
  document.getElementById('detailsModal').classList.remove('active');
}

// Close modal on outside click
window.onclick = function(event) {
  const modal = document.getElementById('detailsModal');
  if (event.target === modal) {
    modal.classList.remove('active');
  }
}
</script>

</body>
</html>
