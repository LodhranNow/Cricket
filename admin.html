<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Mines Game</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
            min-height: 100vh;
            padding: 20px;
        }

        .login-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .login-box {
            background: rgba(255, 255, 255, 0.95);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 50px rgba(0, 0, 0, 0.5);
            max-width: 400px;
            width: 100%;
        }

        .login-title {
            font-size: 32px;
            font-weight: bold;
            color: #1e3c72;
            text-align: center;
            margin-bottom: 30px;
        }

        .login-input {
            width: 100%;
            padding: 15px;
            margin: 15px 0;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
        }

        .login-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
        }

        .login-btn:hover {
            opacity: 0.9;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 20px;
            padding: 30px;
            display: none;
        }

        .container.active {
            display: block;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #FFD700;
        }

        h1 {
            color: #1e3c72;
            font-size: 36px;
        }

        .logout-btn {
            background: linear-gradient(135deg, #DC143C, #8B0000);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            font-size: 16px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .stat-value {
            font-size: 42px;
            font-weight: bold;
            margin: 15px 0;
        }

        .stat-label {
            font-size: 16px;
            opacity: 0.95;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 15px 30px;
            background: #1e3c72;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
        }

        .tab.active {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #000;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(255, 215, 0, 0.4);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        th {
            background: #1e3c72;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: bold;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid #eee;
        }

        tr:hover {
            background: #f8f9fa;
        }

        tr:last-child td {
            border-bottom: none;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            margin: 2px;
            transition: transform 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
        }

        .btn-approve {
            background: #4CAF50;
            color: white;
        }

        .btn-reject {
            background: #f44336;
            color: white;
        }

        .btn-edit {
            background: #2196F3;
            color: white;
        }

        .btn-view {
            background: #FF9800;
            color: white;
        }

        .status-pending {
            color: #FF9800;
            background: rgba(255, 152, 0, 0.15);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: bold;
        }

        .status-approved {
            color: #4CAF50;
            background: rgba(76, 175, 80, 0.15);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: bold;
        }

        .status-rejected {
            color: #f44336;
            background: rgba(244, 67, 54, 0.15);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: bold;
        }

        .no-data {
            text-align: center;
            padding: 60px;
            color: #999;
            font-style: italic;
            font-size: 18px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
        }

        .modal-title {
            font-size: 24px;
            font-weight: bold;
            color: #1e3c72;
            margin-bottom: 25px;
        }

        .modal-input {
            width: 100%;
            padding: 12px;
            margin: 12px 0;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 25px;
        }

        .modal-btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
        }

        .screenshot-img {
            max-width: 200px;
            max-height: 200px;
            cursor: pointer;
            border-radius: 8px;
            border: 2px solid #ddd;
        }

        .screenshot-img:hover {
            transform: scale(1.05);
            border-color: #4CAF50;
        }

        .refresh-btn {
            background: linear-gradient(135deg, #2196F3, #1976D2);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            margin-left: auto;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: #666;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #1e3c72;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
    </style>
</head>
<body>

<!-- LOGIN SCREEN -->
<div id="loginScreen" class="login-screen">
    <div class="login-box">
        <div class="login-title">üîê Admin Login</div>
        <input type="password" id="adminPassword" class="login-input" placeholder="Enter Admin Password">
        <button class="login-btn" onclick="adminLogin()">LOGIN</button>
    </div>
</div>

<!-- ADMIN DASHBOARD -->
<div id="dashboard" class="container">
    <div class="header">
        <h1>üéÆ Admin Dashboard</h1>
        <div style="display: flex; gap: 15px; align-items: center;">
            <button class="refresh-btn" onclick="loadAllData()">üîÑ Refresh</button>
            <button class="logout-btn" onclick="adminLogout()">Logout</button>
        </div>
    </div>

    <!-- Statistics -->
    <div class="stats">
        <div class="stat-card" style="background: linear-gradient(135deg, #667eea, #764ba2);">
            <div class="stat-label">Total Users</div>
            <div class="stat-value" id="totalUsers">0</div>
        </div>
        <div class="stat-card" style="background: linear-gradient(135deg, #f093fb, #f5576c);">
            <div class="stat-label">Pending Deposits</div>
            <div class="stat-value" id="pendingDeposits">0</div>
        </div>
        <div class="stat-card" style="background: linear-gradient(135deg, #4facfe, #00f2fe);">
            <div class="stat-label">Pending Withdrawals</div>
            <div class="stat-value" id="pendingWithdraws">0</div>
        </div>
        <div class="stat-card" style="background: linear-gradient(135deg, #43e97b, #38f9d7);">
            <div class="stat-label">Total Balance</div>
            <div class="stat-value">Rs <span id="totalBalance">0</span></div>
        </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
        <button class="tab active" onclick="showTab('users')">üë• Users</button>
        <button class="tab" onclick="showTab('deposits')">üí∞ Deposits</button>
        <button class="tab" onclick="showTab('withdraws')">üí∏ Withdrawals</button>
    </div>

    <!-- Users Tab -->
    <div id="users" class="tab-content active">
        <h2 style="color: #1e3c72; margin-bottom: 20px;">All Users</h2>
        <div id="usersContent" class="loading">
            <div class="spinner"></div>
            Loading users...
        </div>
    </div>

    <!-- Deposits Tab -->
    <div id="deposits" class="tab-content">
        <h2 style="color: #1e3c72; margin-bottom: 20px;">Deposit Requests</h2>
        <div id="depositsContent" class="loading">
            <div class="spinner"></div>
            Loading deposits...
        </div>
    </div>

    <!-- Withdrawals Tab -->
    <div id="withdraws" class="tab-content">
        <h2 style="color: #1e3c72; margin-bottom: 20px;">Withdrawal Requests</h2>
        <div id="withdrawsContent" class="loading">
            <div class="spinner"></div>
            Loading withdrawals...
        </div>
    </div>
</div>

<!-- Edit Balance Modal -->
<div id="editBalanceModal" class="modal">
    <div class="modal-content">
        <div class="modal-title">Edit User Balance</div>
        <p><strong>User:</strong> <span id="editUserName"></span></p>
        <p><strong>Phone:</strong> <span id="editUserPhone"></span></p>
        <p><strong>Current Balance:</strong> Rs <span id="editCurrentBalance"></span></p>
        <input type="number" id="editNewBalance" class="modal-input" placeholder="Enter new balance">
        <div class="modal-buttons">
            <button class="modal-btn btn-approve" onclick="saveBalance()">Save</button>
            <button class="modal-btn btn-reject" onclick="closeModal()">Cancel</button>
        </div>
    </div>
</div>

<!-- Screenshot Modal -->
<div id="screenshotModal" class="modal" onclick="closeScreenshotModal()">
    <div class="modal-content" style="max-width: 800px;" onclick="event.stopPropagation()">
        <img id="screenshotFullImage" style="width: 100%; border-radius: 10px;">
    </div>
</div>

<script>
// Configuration
const API_URL = 'YOUR_BACKEND_URL_HERE'; // Update this after deployment
const ADMIN_PASSWORD = 'admin123'; // Change this to strong password

let currentEditUser = null;

// Admin login
function adminLogin() {
    const password = document.getElementById('adminPassword').value;
    
    if (password === ADMIN_PASSWORD) {
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('dashboard').classList.add('active');
        loadAllData();
        
        // Save login session
        sessionStorage.setItem('adminLoggedIn', 'true');
    } else {
        alert('Incorrect password!');
    }
}

// Admin logout
function adminLogout() {
    if (confirm('Logout?')) {
        sessionStorage.removeItem('adminLoggedIn');
        location.reload();
    }
}

// Check login on page load
window.onload = function() {
    if (sessionStorage.getItem('adminLoggedIn') === 'true') {
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('dashboard').classList.add('active');
        loadAllData();
    }
};

// Load all data
async function loadAllData() {
    await loadStats();
    await loadUsers();
    await loadDeposits();
    await loadWithdraws();
}

// Load statistics
async function loadStats() {
    try {
        const response = await fetch(API_URL + '/api/admin/stats');
        const data = await response.json();
        
        if (data.success) {
            document.getElementById('totalUsers').textContent = data.stats.totalUsers;
            document.getElementById('pendingDeposits').textContent = data.stats.pendingDeposits;
            document.getElementById('pendingWithdraws').textContent = data.stats.pendingWithdraws;
            document.getElementById('totalBalance').textContent = data.stats.totalBalance.toFixed(2);
        }
    } catch (error) {
        console.error('Stats error:', error);
    }
}

// Load users
async function loadUsers() {
    try {
        const response = await fetch(API_URL + '/api/admin/users');
        const data = await response.json();
        
        const content = document.getElementById('usersContent');
        
        if (data.success && data.users.length > 0) {
            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Phone</th>
                            <th>Balance</th>
                            <th>Total Deposit</th>
                            <th>Total Withdraw</th>
                            <th>Joined</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            data.users.forEach(user => {
                const joinDate = new Date(user.created_at).toLocaleDateString();
                html += `
                    <tr>
                        <td><strong>${user.name}</strong></td>
                        <td>${user.phone}</td>
                        <td><strong>Rs ${parseFloat(user.balance).toFixed(2)}</strong></td>
                        <td>Rs ${parseFloat(user.total_deposit || 0).toFixed(2)}</td>
                        <td>Rs ${parseFloat(user.total_withdraw || 0).toFixed(2)}</td>
                        <td>${joinDate}</td>
                        <td>
                            <button class="btn-edit" onclick="editBalance(${user.id}, '${user.name}', '${user.phone}', ${user.balance})">
                                Edit Balance
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            content.innerHTML = html;
        } else {
            content.innerHTML = '<div class="no-data">No users yet</div>';
        }
    } catch (error) {
        console.error('Users error:', error);
        document.getElementById('usersContent').innerHTML = '<div class="no-data">Error loading users</div>';
    }
}

// Load deposits
async function loadDeposits() {
    try {
        const response = await fetch(API_URL + '/api/admin/deposits');
        const data = await response.json();
        
        const content = document.getElementById('depositsContent');
        
        if (data.success && data.requests.length > 0) {
            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>User</th>
                            <th>Phone</th>
                            <th>Amount</th>
                            <th>Screenshot</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            data.requests.forEach(req => {
                const date = new Date(req.created_at).toLocaleString();
                const statusClass = req.status === 'pending' ? 'status-pending' : 
                                  req.status === 'approved' ? 'status-approved' : 'status-rejected';
                
                html += `
                    <tr>
                        <td>${date}</td>
                        <td><strong>${req.name}</strong></td>
                        <td>${req.phone}</td>
                        <td><strong>Rs ${parseFloat(req.amount).toFixed(2)}</strong></td>
                        <td>
                            ${req.screenshot_url ? 
                                `<img src="${API_URL}/uploads/${req.screenshot_url}" 
                                     class="screenshot-img" 
                                     onclick="viewScreenshot('${API_URL}/uploads/${req.screenshot_url}')" 
                                     alt="Screenshot">` 
                                : 'N/A'}
                        </td>
                        <td><span class="${statusClass}">${req.status.toUpperCase()}</span></td>
                        <td>
                            ${req.status === 'pending' ? `
                                <button class="btn-approve" onclick="approveDeposit(${req.id})">‚úì Approve</button>
                                <button class="btn-reject" onclick="rejectDeposit(${req.id})">‚úó Reject</button>
                            ` : '-'}
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            content.innerHTML = html;
        } else {
            content.innerHTML = '<div class="no-data">No deposit requests</div>';
        }
    } catch (error) {
        console.error('Deposits error:', error);
        document.getElementById('depositsContent').innerHTML = '<div class="no-data">Error loading deposits</div>';
    }
}

// Load withdrawals
async function loadWithdraws() {
    try {
        const response = await fetch(API_URL + '/api/admin/withdraws');
        const data = await response.json();
        
        const content = document.getElementById('withdrawsContent');
        
        if (data.success && data.requests.length > 0) {
            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>User</th>
                            <th>Phone</th>
                            <th>JazzCash Number</th>
                            <th>Amount</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            data.requests.forEach(req => {
                const date = new Date(req.created_at).toLocaleString();
                const statusClass = req.status === 'pending' ? 'status-pending' : 
                                  req.status === 'approved' ? 'status-approved' : 'status-rejected';
                
                html += `
                    <tr>
                        <td>${date}</td>
                        <td><strong>${req.name}</strong></td>
                        <td>${req.phone}</td>
                        <td><strong>${req.jazzcash_number}</strong></td>
                        <td><strong>Rs ${parseFloat(req.amount).toFixed(2)}</strong></td>
                        <td><span class="${statusClass}">${req.status.toUpperCase()}</span></td>
                        <td>
                            ${req.status === 'pending' ? `
                                <button class="btn-approve" onclick="approveWithdraw(${req.id})">‚úì Approve</button>
                                <button class="btn-reject" onclick="rejectWithdraw(${req.id})">‚úó Reject</button>
                            ` : '-'}
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            content.innerHTML = html;
        } else {
            content.innerHTML = '<div class="no-data">No withdrawal requests</div>';
        }
    } catch (error) {
        console.error('Withdraws error:', error);
        document.getElementById('withdrawsContent').innerHTML = '<div class="no-data">Error loading withdrawals</div>';
    }
}

// Approve deposit
async function approveDeposit(requestId) {
    if (!confirm('Approve this deposit? User balance will be credited.')) return;
    
    try {
        const response = await fetch(API_URL + '/api/admin/deposit/approve', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ requestId, adminName: 'Admin' })
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('‚úÖ Deposit approved!');
            loadAllData();
        } else {
            alert('Error: ' + data.message);
        }
    } catch (error) {
        console.error('Approve error:', error);
        alert('Connection error');
    }
}

// Reject deposit
async function rejectDeposit(requestId) {
    const reason = prompt('Rejection reason (optional):') || 'No reason provided';
    
    try {
        const response = await fetch(API_URL + '/api/admin/deposit/reject', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ requestId, reason, adminName: 'Admin' })
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('‚úÖ Deposit rejected');
            loadAllData();
        } else {
            alert('Error: ' + data.message);
        }
    } catch (error) {
        console.error('Reject error:', error);
        alert('Connection error');
    }
}

// Approve withdrawal
async function approveWithdraw(requestId) {
    const confirm1 = confirm('Step 1: Have you sent money to user\'s JazzCash?');
    if (!confirm1) {
        alert('Please send money first, then approve.');
        return;
    }
    
    const confirm2 = confirm('Step 2: Confirm approval? User balance will be deducted.');
    if (!confirm2) return;
    
    try {
        const response = await fetch(API_URL + '/api/admin/withdraw/approve', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ requestId, adminName: 'Admin' })
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('‚úÖ Withdrawal approved!');
            loadAllData();
        } else {
            alert('Error: ' + data.message);
        }
    } catch (error) {
        console.error('Approve error:', error);
        alert('Connection error');
    }
}

// Reject withdrawal
async function rejectWithdraw(requestId) {
    const reason = prompt('Rejection reason (optional):') || 'No reason provided';
    
    try {
        const response = await fetch(API_URL + '/api/admin/withdraw/reject', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ requestId, reason, adminName: 'Admin' })
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('‚úÖ Withdrawal rejected');
            loadAllData();
        } else {
            alert('Error: ' + data.message);
        }
    } catch (error) {
        console.error('Reject error:', error);
        alert('Connection error');
    }
}

// Edit balance
function editBalance(userId, name, phone, balance) {
    currentEditUser = userId;
    document.getElementById('editUserName').textContent = name;
    document.getElementById('editUserPhone').textContent = phone;
    document.getElementById('editCurrentBalance').textContent = parseFloat(balance).toFixed(2);
    document.getElementById('editNewBalance').value = parseFloat(balance).toFixed(2);
    document.getElementById('editBalanceModal').classList.add('active');
}

// Save balance
async function saveBalance() {
    const newBalance = parseFloat(document.getElementById('editNewBalance').value);
    
    if (isNaN(newBalance) || newBalance < 0) {
        alert('Invalid balance!');
        return;
    }
    
    try {
        const response = await fetch(API_URL + '/api/admin/user/update-balance', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userId: currentEditUser, newBalance })
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('‚úÖ Balance updated!');
            closeModal();
            loadAllData();
        } else {
            alert('Error: ' + data.message);
        }
    } catch (error) {
        console.error('Update error:', error);
        alert('Connection error');
    }
}

// View screenshot
function viewScreenshot(url) {
    document.getElementById('screenshotFullImage').src = url;
    document.getElementById('screenshotModal').classList.add('active');
}

function closeScreenshotModal() {
    document.getElementById('screenshotModal').classList.remove('active');
}

// Close modal
function closeModal() {
    document.getElementById('editBalanceModal').classList.remove('active');
    currentEditUser = null;
}

// Show tab
function showTab(tabName) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    
    event.target.classList.add('active');
    document.getElementById(tabName).classList.add('active');
}

// Auto refresh every 30 seconds
setInterval(loadAllData, 30000);
</script>

</body>
</html>
