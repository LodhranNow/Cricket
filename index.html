<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mines Game - Secure Payment</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;700;900&family=Rajdhani:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getDatabase, ref, set, get, onValue, push, update, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyA8C1-TpsRo0UsATshlI8Dy0v40PnLRlc4",
    authDomain: "mines-67d8c.firebaseapp.com",
    databaseURL: "https://mines-67d8c-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "mines-67d8c",
    storageBucket: "mines-67d8c.firebasestorage.app",
    messagingSenderId: "918317634273",
    appId: "1:918317634273:web:8527c0d58a1f3de0371da0",
    measurementId: "G-NHC6K1X3KZ"
  };

  const app = initializeApp(firebaseConfig);
  window.db = getDatabase(app);
  window.dbRef = ref;
  window.dbSet = set;
  window.dbGet = get;
  window.dbOnValue = onValue;
  window.dbPush = push;
  window.dbUpdate = update;
  window.dbRemove = remove;
</script>

<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CSS VARIABLES & RESET
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --gold:          #f0c040;
  --gold-dim:      #c89a28;
  --neon-cyan:     #22d3ee;
  --neon-emerald:  #34d399;
  --neon-amber:    #fbbf24;
  --neon-rose:     #fb7185;
  --neon-blue:     #60a5fa;
  --bg-deep:       #0a0c14;
  --glass-bg:      rgba(18, 22, 40, 0.65);
  --glass-border:  rgba(255,255,255,0.11);
  --glass-border2: rgba(255,255,255,0.22);
  --text-primary:  #f0f0f5;
  --text-muted:    #9aa0b8;
  --radius:        16px;
  --radius-sm:     10px;
  --blur-main:     24px;
  --blur-modal:    30px;
  --blur-tile:     6px;
}
* { margin:0; padding:0; box-sizing:border-box; }
html, body {
  height:100%; min-height:100vh;
  font-family:'Rajdhani', sans-serif;
  background: var(--bg-deep);
  color: var(--text-primary);
  overflow-x: hidden;
  -webkit-font-smoothing: antialiased;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CANVAS BG
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#bgCanvas {
  position:fixed; top:0; left:0;
  width:100%; height:100%;
  z-index:0; pointer-events:none;
}

body::before {
  content:'';
  position:fixed; inset:0; z-index:1;
  pointer-events:none; opacity:.04;
  background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
  background-size:200px 200px;
}

.page-wrap {
  position:relative; z-index:2;
  min-height:100vh;
  display:flex; justify-content:center;
  align-items:flex-start;
  padding:28px 16px 48px;
}

.container {
  background: var(--glass-bg);
  backdrop-filter: blur(var(--blur-main)) saturate(1.4);
  -webkit-backdrop-filter: blur(var(--blur-main)) saturate(1.4);
  border: 1.5px solid var(--glass-border);
  border-radius: var(--radius);
  box-shadow: 0 8px 40px rgba(0,0,0,.52),
              inset 0 1px 0 rgba(255,255,255,.07);
  max-width:480px; width:100%;
  padding:28px 22px 32px;
  margin-top:20px;
}
.hidden { display:none !important; }

.title {
  font-family:'Orbitron', sans-serif;
  font-size:50px; font-weight:900;
  letter-spacing:13px; text-align:center;
  margin-bottom:4px;
  background: linear-gradient(135deg, #f0c040 0%, #fbbf24 45%, #f59e0b 75%, #f0c040 100%);
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
  background-clip:text;
  filter: drop-shadow(0 0 20px rgba(240,192,64,.42));
}

.subtitle {
  text-align:center;
  color: var(--text-muted);
  font-size:13px;
  font-weight:500;
  letter-spacing:3px;
  text-transform:uppercase;
  margin-bottom:28px;
}

/* Balance Display */
.balance-display {
  background: linear-gradient(135deg, rgba(34,211,238,0.12), rgba(52,211,153,0.12));
  border: 1.5px solid var(--neon-cyan);
  border-radius: var(--radius-sm);
  padding:18px;
  margin-bottom:24px;
  text-align:center;
  position:relative;
  overflow:hidden;
}
.balance-display::before {
  content:'';
  position:absolute;
  top:0; left:-100%;
  width:100%; height:100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
  animation: shimmer 3s infinite;
}
@keyframes shimmer {
  to { left:100%; }
}
.balance-label {
  font-size:12px;
  color: var(--neon-cyan);
  font-weight:600;
  letter-spacing:2px;
  text-transform:uppercase;
  margin-bottom:6px;
}
.balance-amount {
  font-family:'Orbitron', sans-serif;
  font-size:36px;
  font-weight:700;
  color: var(--neon-cyan);
  text-shadow: 0 0 20px rgba(34,211,238,0.6);
}

/* Buttons */
.btn-row {
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:12px;
  margin-bottom:20px;
}
button {
  border:none;
  border-radius: var(--radius-sm);
  padding:16px;
  font-family:'Rajdhani', sans-serif;
  font-size:15px;
  font-weight:700;
  letter-spacing:1.5px;
  text-transform:uppercase;
  cursor:pointer;
  transition: all 0.3s ease;
  position:relative;
  overflow:hidden;
}
button::before {
  content:'';
  position:absolute;
  top:50%; left:50%;
  width:0; height:0;
  border-radius:50%;
  background: rgba(255,255,255,0.3);
  transform: translate(-50%, -50%);
  transition: width 0.6s, height 0.6s;
}
button:active::before {
  width:300px; height:300px;
}

.btn-green {
  background: linear-gradient(135deg, #34d399, #10b981);
  color: #fff;
  box-shadow: 0 4px 16px rgba(52,211,153,0.4);
}
.btn-green:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(52,211,153,0.6);
}

.btn-red {
  background: linear-gradient(135deg, #fb7185, #f43f5e);
  color: #fff;
  box-shadow: 0 4px 16px rgba(251,113,133,0.4);
}
.btn-red:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(251,113,133,0.6);
}

.btn-orange {
  background: linear-gradient(135deg, var(--neon-amber), #f59e0b);
  color: #0a0c14;
  box-shadow: 0 4px 16px rgba(251,191,36,0.4);
  width:100%;
  margin-top:16px;
}
.btn-orange:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(251,191,36,0.6);
}

.btn-blue {
  background: linear-gradient(135deg, #60a5fa, #3b82f6);
  color: #fff;
  box-shadow: 0 4px 16px rgba(96,165,250,0.4);
  padding:12px 24px;
  font-size:13px;
  margin:8px auto;
  display:block;
}

/* Modal */
.modal {
  display:none;
  position:fixed;
  top:0; left:0;
  width:100%; height:100%;
  background: rgba(0,0,0,0.85);
  backdrop-filter: blur(8px);
  z-index:9999;
  animation: fadeIn 0.3s;
}
@keyframes fadeIn {
  from { opacity:0; }
  to { opacity:1; }
}
.modal-content {
  position:absolute;
  top:50%; left:50%;
  transform: translate(-50%, -50%);
  background: var(--glass-bg);
  backdrop-filter: blur(var(--blur-modal));
  border: 1.5px solid var(--glass-border2);
  border-radius: var(--radius);
  padding:32px 24px;
  max-width:420px;
  width:90%;
  box-shadow: 0 12px 48px rgba(0,0,0,0.7);
}
.modal-title {
  font-family:'Orbitron', sans-serif;
  font-size:24px;
  font-weight:700;
  text-align:center;
  margin-bottom:24px;
  color: var(--gold);
}
.close {
  position:absolute;
  top:16px; right:20px;
  font-size:32px;
  color: var(--text-muted);
  cursor:pointer;
  transition: color 0.3s;
}
.close:hover {
  color: var(--neon-rose);
}

/* Payment Method Selection */
.payment-tabs {
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:10px;
  margin-bottom:24px;
}
.payment-tab {
  background: rgba(255,255,255,0.05);
  border: 1.5px solid rgba(255,255,255,0.1);
  border-radius: var(--radius-sm);
  padding:16px;
  text-align:center;
  cursor:pointer;
  transition: all 0.3s;
  position:relative;
}
.payment-tab:hover {
  background: rgba(255,255,255,0.08);
  border-color: var(--neon-cyan);
}
.payment-tab.active {
  background: linear-gradient(135deg, rgba(34,211,238,0.15), rgba(52,211,153,0.15));
  border-color: var(--neon-cyan);
  box-shadow: 0 0 20px rgba(34,211,238,0.3);
}
.payment-tab-icon {
  font-size:32px;
  margin-bottom:8px;
}
.payment-tab-name {
  font-size:14px;
  font-weight:600;
  color: var(--text-primary);
}

/* Input Fields */
input[type="number"], input[type="text"] {
  width:100%;
  background: rgba(255,255,255,0.05);
  border: 1.5px solid rgba(255,255,255,0.1);
  border-radius: var(--radius-sm);
  padding:14px 16px;
  font-family:'Rajdhani', sans-serif;
  font-size:16px;
  color: var(--text-primary);
  margin-bottom:16px;
  transition: all 0.3s;
}
input:focus {
  outline:none;
  border-color: var(--neon-cyan);
  box-shadow: 0 0 20px rgba(34,211,238,0.2);
}
input::placeholder {
  color: var(--text-muted);
}

/* Status Messages */
.status-msg {
  padding:12px;
  border-radius: var(--radius-sm);
  margin-bottom:16px;
  text-align:center;
  font-weight:600;
  animation: slideDown 0.4s;
}
@keyframes slideDown {
  from { opacity:0; transform: translateY(-10px); }
  to { opacity:1; transform: translateY(0); }
}
.status-success {
  background: rgba(52,211,153,0.15);
  border: 1px solid var(--neon-emerald);
  color: var(--neon-emerald);
}
.status-error {
  background: rgba(251,113,133,0.15);
  border: 1px solid var(--neon-rose);
  color: var(--neon-rose);
}
.status-pending {
  background: rgba(251,191,36,0.15);
  border: 1px solid var(--neon-amber);
  color: var(--neon-amber);
}

/* Pending Transaction Status */
.pending-status {
  background: rgba(251,191,36,0.1);
  border: 1.5px solid var(--neon-amber);
  border-radius: var(--radius-sm);
  padding:16px;
  margin-bottom:20px;
  text-align:center;
}
.pending-amount {
  font-size:24px;
  font-weight:700;
  color: var(--neon-amber);
  margin:8px 0;
}
.transaction-id {
  font-size:11px;
  color: var(--text-muted);
  margin-top:6px;
  font-family: monospace;
}

/* Loader */
.loader {
  border: 3px solid rgba(255,255,255,0.1);
  border-top: 3px solid var(--neon-cyan);
  border-radius: 50%;
  width: 40px;
  height: 40px;
  animation: spin 1s linear infinite;
  margin: 20px auto;
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* Login Screen */
#loginScreen {
  text-align:center;
}
#loginScreen input {
  max-width:300px;
  margin:0 auto 16px;
}
</style>
</head>
<body>

<canvas id="bgCanvas"></canvas>

<div class="page-wrap">
  <div class="container">
    
    <!-- LOGIN SCREEN -->
    <div id="loginScreen">
      <h1 class="title">MINES</h1>
      <p class="subtitle">Secure Gaming Platform</p>
      <input type="text" id="loginPhone" placeholder="Enter Phone Number" maxlength="11">
      <button class="btn-orange" onclick="handleLogin()">Login / Register</button>
    </div>

    <!-- MAIN GAME SCREEN -->
    <div id="gameScreen" class="hidden">
      <h1 class="title">MINES</h1>
      <p class="subtitle">Balance Dashboard</p>

      <!-- Balance Display -->
      <div class="balance-display">
        <div class="balance-label">Your Balance</div>
        <div class="balance-amount">Rs <span id="userBalance">0</span></div>
      </div>

      <!-- Pending Deposit Status -->
      <div id="pendingDepositStatus" class="pending-status hidden">
        <div style="color:var(--neon-amber); font-weight:600; margin-bottom:6px;">â³ Payment Processing</div>
        <div class="pending-amount" id="pendingDepositAmount">Rs 0</div>
        <div class="transaction-id" id="pendingTransactionId"></div>
        <div style="font-size:13px; color:var(--text-muted); margin-top:8px;">
          Waiting for payment confirmation...
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="btn-row">
        <button class="btn-green" onclick="openDepositModal()">ğŸ’° DEPOSIT</button>
        <button class="btn-red" onclick="openWithdrawModal()">ğŸ¦ WITHDRAW</button>
      </div>

      <button class="btn-blue" onclick="handleLogout()">Logout</button>
    </div>

  </div>
</div>

<!-- DEPOSIT MODAL -->
<div id="depositModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeDepositModal()">&times;</span>
    <div class="modal-title">ğŸ’³ Secure Deposit</div>
    
    <div id="depositStatusMsg"></div>

    <!-- Payment Method Selection -->
    <div class="payment-tabs">
      <div class="payment-tab active" id="tabJazz" onclick="selectPaymentMethod('jazzcash')">
        <div class="payment-tab-icon">ğŸ“±</div>
        <div class="payment-tab-name">JazzCash</div>
      </div>
      <div class="payment-tab" id="tabEasy" onclick="selectPaymentMethod('easypaisa')">
        <div class="payment-tab-icon">ğŸ’³</div>
        <div class="payment-tab-name">EasyPaisa</div>
      </div>
    </div>

    <!-- Amount Input -->
    <input type="number" id="depositAmount" placeholder="Enter Amount (Min Rs 500)" min="500" step="100">

    <!-- Submit Button -->
    <button class="btn-orange" onclick="initiateDeposit()">
      ğŸš€ Pay Now
    </button>

    <div style="font-size:11px; color:var(--text-muted); text-align:center; margin-top:16px;">
      ğŸ”’ Secure gateway Â· No data stored Â· Auto-verified
    </div>
  </div>
</div>

<!-- WITHDRAW MODAL (Placeholder) -->
<div id="withdrawModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeWithdrawModal()">&times;</span>
    <div class="modal-title">ğŸ¦ Withdraw</div>
    <p style="text-align:center; color:var(--text-muted);">
      Withdraw feature coming soon...
    </p>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GLOBAL VARIABLES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let currentUser = null;
let selectedPaymentMethod = 'jazzcash';
let pendingTransactionListener = null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CANVAS BACKGROUND ANIMATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const canvas = document.getElementById('bgCanvas');
const ctx = canvas.getContext('2d');
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

const particles = [];
for(let i=0; i<80; i++) {
  particles.push({
    x: Math.random() * canvas.width,
    y: Math.random() * canvas.height,
    radius: Math.random() * 2 + 1,
    dx: (Math.random() - 0.5) * 0.5,
    dy: (Math.random() - 0.5) * 0.5,
    color: `rgba(${Math.random() > 0.5 ? '34,211,238' : '52,211,153'}, ${Math.random() * 0.5 + 0.2})`
  });
}

function animateParticles() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  particles.forEach(p => {
    ctx.beginPath();
    ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
    ctx.fillStyle = p.color;
    ctx.fill();
    p.x += p.dx;
    p.y += p.dy;
    if (p.x < 0 || p.x > canvas.width) p.dx *= -1;
    if (p.y < 0 || p.y > canvas.height) p.dy *= -1;
  });
  requestAnimationFrame(animateParticles);
}
animateParticles();

window.addEventListener('resize', () => {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTHENTICATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function handleLogin() {
  const phone = document.getElementById('loginPhone').value.trim();
  
  if (!phone || phone.length < 10) {
    showStatus('depositStatusMsg', 'Please enter a valid phone number', 'error');
    return;
  }
  
  try {
    const userRef = dbRef(db, `users/${phone}`);
    const snapshot = await dbGet(userRef);
    
    if (!snapshot.exists()) {
      // Register new user
      await dbSet(userRef, {
        phone: phone,
        balance: 0,
        createdAt: Date.now(),
        lastLogin: Date.now()
      });
    } else {
      // Update last login
      await dbUpdate(userRef, { lastLogin: Date.now() });
    }
    
    currentUser = phone;
    localStorage.setItem('currentUser', phone);
    showGameScreen();
    loadUserBalance();
    checkPendingTransactions();
    
  } catch (error) {
    console.error('Login error:', error);
    showStatus('depositStatusMsg', 'Login failed. Please try again.', 'error');
  }
}

function handleLogout() {
  if (pendingTransactionListener) {
    pendingTransactionListener();
  }
  currentUser = null;
  localStorage.removeItem('currentUser');
  document.getElementById('gameScreen').classList.add('hidden');
  document.getElementById('loginScreen').classList.remove('hidden');
}

function showGameScreen() {
  document.getElementById('loginScreen').classList.add('hidden');
  document.getElementById('gameScreen').classList.remove('hidden');
}

// Check for existing session
window.addEventListener('load', () => {
  const savedUser = localStorage.getItem('currentUser');
  if (savedUser) {
    currentUser = savedUser;
    showGameScreen();
    loadUserBalance();
    checkPendingTransactions();
  }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BALANCE MANAGEMENT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadUserBalance() {
  if (!currentUser) return;
  
  const userRef = dbRef(db, `users/${currentUser}`);
  dbOnValue(userRef, (snapshot) => {
    if (snapshot.exists()) {
      const userData = snapshot.val();
      document.getElementById('userBalance').textContent = userData.balance || 0;
    }
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DEPOSIT SYSTEM - SECURE GATEWAY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openDepositModal() {
  document.getElementById('depositModal').style.display = 'block';
  document.getElementById('depositStatusMsg').innerHTML = '';
  document.getElementById('depositAmount').value = '';
}

function closeDepositModal() {
  document.getElementById('depositModal').style.display = 'none';
}

function selectPaymentMethod(method) {
  selectedPaymentMethod = method;
  
  document.getElementById('tabJazz').classList.remove('active');
  document.getElementById('tabEasy').classList.remove('active');
  
  if (method === 'jazzcash') {
    document.getElementById('tabJazz').classList.add('active');
  } else {
    document.getElementById('tabEasy').classList.add('active');
  }
}

async function initiateDeposit() {
  const amount = parseInt(document.getElementById('depositAmount').value);
  
  // Validation
  if (!amount || amount < 500) {
    showStatus('depositStatusMsg', 'Minimum deposit is Rs 500', 'error');
    return;
  }
  
  if (!currentUser) {
    showStatus('depositStatusMsg', 'Please login first', 'error');
    return;
  }
  
  // Check for existing pending transaction
  const existingPending = await checkExistingPending();
  if (existingPending) {
    showStatus('depositStatusMsg', 'You already have a pending transaction. Please wait for it to complete.', 'error');
    return;
  }
  
  try {
    showStatus('depositStatusMsg', '<div class="loader"></div>Initiating payment gateway...', 'pending');
    
    // Generate unique transaction ID
    const transactionId = generateTransactionId();
    
    // Create transaction record
    const transactionData = {
      transactionId: transactionId,
      userId: currentUser,
      amount: amount,
      paymentMethod: selectedPaymentMethod,
      status: 'PENDING',
      createdAt: Date.now(),
      expiresAt: Date.now() + (15 * 60 * 1000), // 15 minutes expiry
    };
    
    // Save to Firebase
    const transactionRef = dbRef(db, `transactions/${transactionId}`);
    await dbSet(transactionRef, transactionData);
    
    // Close modal
    closeDepositModal();
    
    // Show pending status
    showPendingTransaction(amount, transactionId);
    
    // Open payment gateway
    openPaymentGateway(transactionId, amount, selectedPaymentMethod);
    
    // Start listening for transaction updates
    startTransactionListener(transactionId);
    
  } catch (error) {
    console.error('Deposit error:', error);
    showStatus('depositStatusMsg', 'Payment initiation failed. Please try again.', 'error');
  }
}

function generateTransactionId() {
  const timestamp = Date.now();
  const random = Math.random().toString(36).substring(2, 9).toUpperCase();
  return `TXN${timestamp}${random}`;
}

async function checkExistingPending() {
  const transactionsRef = dbRef(db, 'transactions');
  const snapshot = await dbGet(transactionsRef);
  
  if (snapshot.exists()) {
    const transactions = snapshot.val();
    for (let txnId in transactions) {
      const txn = transactions[txnId];
      if (txn.userId === currentUser && txn.status === 'PENDING') {
        // Check if not expired
        if (txn.expiresAt > Date.now()) {
          return true;
        }
      }
    }
  }
  return false;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PAYMENT GATEWAY DEEP LINKING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openPaymentGateway(transactionId, amount, method) {
  // In production, this would call actual JazzCash/EasyPaisa APIs
  // For now, we'll use deep links (these are examples)
  
  let deepLink = '';
  
  if (method === 'jazzcash') {
    // JazzCash deep link format (example)
    // In production, you'd get this URL from JazzCash API after transaction creation
    deepLink = `jazzcash://payment?amount=${amount}&orderId=${transactionId}&merchantId=YOUR_MERCHANT_ID`;
    
    // Fallback for web
    window.location.href = deepLink;
    
    // If deep link fails, redirect to web gateway
    setTimeout(() => {
      // This would be actual JazzCash gateway URL in production
      alert('Opening JazzCash payment gateway...\n\nIn production, this would redirect to actual JazzCash payment page.\n\nTransaction ID: ' + transactionId);
    }, 1000);
    
  } else if (method === 'easypaisa') {
    // EasyPaisa deep link format (example)
    deepLink = `easypaisa://payment?amount=${amount}&orderId=${transactionId}&merchantId=YOUR_MERCHANT_ID`;
    
    window.location.href = deepLink;
    
    setTimeout(() => {
      alert('Opening EasyPaisa payment gateway...\n\nIn production, this would redirect to actual EasyPaisa payment page.\n\nTransaction ID: ' + transactionId);
    }, 1000);
  }
  
  // Note: In production environment:
  // 1. Backend creates transaction with JazzCash/EasyPaisa API
  // 2. Gets payment URL from gateway
  // 3. Redirects user to gateway URL
  // 4. Gateway processes payment
  // 5. User authenticates in wallet app
  // 6. Gateway sends callback to your webhook
  // 7. Webhook verifies and updates transaction status
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TRANSACTION STATUS LISTENER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startTransactionListener(transactionId) {
  const transactionRef = dbRef(db, `transactions/${transactionId}`);
  
  // Remove previous listener if exists
  if (pendingTransactionListener) {
    pendingTransactionListener();
  }
  
  // Listen for status changes
  pendingTransactionListener = dbOnValue(transactionRef, async (snapshot) => {
    if (snapshot.exists()) {
      const txnData = snapshot.val();
      
      if (txnData.status === 'SUCCESS') {
        // Payment successful - credit balance
        await creditUserBalance(txnData.userId, txnData.amount, transactionId);
        hidePendingTransaction();
        showSuccessNotification(txnData.amount);
        
        // Stop listening
        if (pendingTransactionListener) {
          pendingTransactionListener();
          pendingTransactionListener = null;
        }
        
      } else if (txnData.status === 'FAILED' || txnData.status === 'EXPIRED') {
        // Payment failed
        hidePendingTransaction();
        alert('Payment ' + txnData.status.toLowerCase() + '. Please try again.');
        
        // Stop listening
        if (pendingTransactionListener) {
          pendingTransactionListener();
          pendingTransactionListener = null;
        }
      }
    }
  });
}

async function creditUserBalance(userId, amount, transactionId) {
  const userRef = dbRef(db, `users/${userId}`);
  const snapshot = await dbGet(userRef);
  
  if (snapshot.exists()) {
    const currentBalance = snapshot.val().balance || 0;
    const newBalance = currentBalance + amount;
    
    await dbUpdate(userRef, { 
      balance: newBalance,
      lastDeposit: {
        amount: amount,
        transactionId: transactionId,
        timestamp: Date.now()
      }
    });
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UI HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showPendingTransaction(amount, transactionId) {
  document.getElementById('pendingDepositAmount').textContent = `Rs ${amount}`;
  document.getElementById('pendingTransactionId').textContent = `ID: ${transactionId}`;
  document.getElementById('pendingDepositStatus').classList.remove('hidden');
}

function hidePendingTransaction() {
  document.getElementById('pendingDepositStatus').classList.add('hidden');
}

async function checkPendingTransactions() {
  if (!currentUser) return;
  
  const transactionsRef = dbRef(db, 'transactions');
  const snapshot = await dbGet(transactionsRef);
  
  if (snapshot.exists()) {
    const transactions = snapshot.val();
    for (let txnId in transactions) {
      const txn = transactions[txnId];
      if (txn.userId === currentUser && txn.status === 'PENDING') {
        if (txn.expiresAt > Date.now()) {
          showPendingTransaction(txn.amount, txn.transactionId);
          startTransactionListener(txn.transactionId);
          break;
        }
      }
    }
  }
}

function showSuccessNotification(amount) {
  // Create notification element
  const notification = document.createElement('div');
  notification.className = 'status-msg status-success';
  notification.innerHTML = `âœ… Payment Successful! Rs ${amount} credited to your account.`;
  notification.style.position = 'fixed';
  notification.style.top = '20px';
  notification.style.left = '50%';
  notification.style.transform = 'translateX(-50%)';
  notification.style.zIndex = '99999';
  notification.style.minWidth = '300px';
  
  document.body.appendChild(notification);
  
  setTimeout(() => {
    notification.remove();
  }, 5000);
}

function showStatus(elementId, message, type) {
  const element = document.getElementById(elementId);
  element.innerHTML = `<div class="status-msg status-${type}">${message}</div>`;
  
  setTimeout(() => {
    element.innerHTML = '';
  }, 5000);
}

function openWithdrawModal() {
  document.getElementById('withdrawModal').style.display = 'block';
}

function closeWithdrawModal() {
  document.getElementById('withdrawModal').style.display = 'none';
}

// Close modals on outside click
window.onclick = function(event) {
  if (event.target.classList.contains('modal')) {
    event.target.style.display = 'none';
  }
}
</script>

</body>
</html>
